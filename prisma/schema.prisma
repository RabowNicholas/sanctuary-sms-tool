// SMS Broadcast System Database Schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Subscriber {
  id               String      @id @default(cuid())
  phoneNumber      String      @unique
  isActive         Boolean     @default(true)
  joinedAt         DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  slackThreadTs    String?     // Slack thread timestamp for grouping
  lastReadAt       DateTime?   // When admin last read this conversation
  joinedViaKeyword String?     // Keyword used to subscribe (e.g., "TRIBE", "FLOW")
  messages         Message[]
  linkClicks       LinkClick[]
  listMemberships  SubscriberListMembership[]

  @@map("subscribers")
}

model Message {
  id             String          @id @default(cuid())
  phoneNumber    String
  content        String
  direction      Direction
  createdAt      DateTime        @default(now())
  subscriber     Subscriber?     @relation(fields: [phoneNumber], references: [phoneNumber])
  broadcastId    String?
  broadcast      Broadcast?      @relation(fields: [broadcastId], references: [id])
  twilioSid      String?         @unique // Twilio message SID for tracking
  deliveryStatus DeliveryStatus? @default(SENT)

  @@map("messages")
}

model AppConfig {
  id             String @id @default("config")
  optInKeyword   String @default("TRIBE")
  autoResponse   String @default("Welcome! You're subscribed. Reply STOP to unsubscribe.")
  alreadySubbed  String @default("You're already in the tribe!")
  welcomeMessage String @default("Welcome to SANCTUARY!")

  @@map("app_config")
}

model Broadcast {
  id         String    @id @default(cuid())
  name       String?   // Optional campaign name
  message    String    // Original message content
  sentCount  Int       // Number of messages sent
  totalCost  Float     // Total cost in dollars
  targetAll  Boolean   @default(true)  // If true, targets all subscribers
  createdAt  DateTime  @default(now())
  messages   Message[]
  links      Link[]
  targets    BroadcastTarget[]

  @@map("broadcasts")
}

model Link {
  id          String      @id @default(cuid())
  broadcastId String
  broadcast   Broadcast   @relation(fields: [broadcastId], references: [id], onDelete: Cascade)
  originalUrl String      // The original URL
  shortCode   String      @unique // Unique short code (e.g., "abc123")
  createdAt   DateTime    @default(now())
  clicks      LinkClick[]

  @@map("links")
}

model LinkClick {
  id           String     @id @default(cuid())
  linkId       String
  link         Link       @relation(fields: [linkId], references: [id], onDelete: Cascade)
  subscriberId String?
  subscriber   Subscriber? @relation(fields: [subscriberId], references: [id])
  clickedAt    DateTime   @default(now())

  @@map("link_clicks")
}

model SignupKeyword {
  id           String          @id @default(cuid())
  keyword      String          @unique    // "TRIBE", "FLOW", etc.
  autoResponse String                     // Welcome message for this keyword
  isActive     Boolean         @default(true)
  listId       String?                    // Auto-add subscribers to this list
  list         SubscriberList? @relation(fields: [listId], references: [id])
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@map("signup_keywords")
}

model SubscriberList {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  subscribers SubscriberListMembership[]
  keywords    SignupKeyword[]
  broadcasts  BroadcastTarget[]

  @@map("subscriber_lists")
}

model SubscriberListMembership {
  id           String         @id @default(cuid())
  subscriberId String
  listId       String
  joinedAt     DateTime       @default(now())
  joinedVia    String?        // "keyword:FLOW", "manual", etc.
  subscriber   Subscriber     @relation(fields: [subscriberId], references: [id], onDelete: Cascade)
  list         SubscriberList @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@unique([subscriberId, listId])
  @@map("subscriber_list_memberships")
}

model BroadcastTarget {
  id          String         @id @default(cuid())
  broadcastId String
  listId      String
  type        String         @default("include")  // "include" | "exclude"
  broadcast   Broadcast      @relation(fields: [broadcastId], references: [id], onDelete: Cascade)
  list        SubscriberList @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@unique([broadcastId, listId, type])
  @@map("broadcast_targets")
}

enum Direction {
  INBOUND
  OUTBOUND
}

enum DeliveryStatus {
  SENT
  DELIVERED
  FAILED
  UNDELIVERED
}
